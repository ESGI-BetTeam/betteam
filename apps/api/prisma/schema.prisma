// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// SPORTS DATA MODELS (TheSportsDB sync)
// ============================================

model Competition {
  id          String   @id @default(cuid())
  externalId  String   @unique @map("external_id")
  name        String
  sport       String
  country     String?
  logoUrl     String?  @map("logo_url")
  isActive    Boolean  @default(true) @map("is_active")
  syncedAt    DateTime @default(now()) @map("synced_at")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  matches     Match[]
  syncLogs    SyncLog[]
  leagues     League[]  @relation("LeagueCompetition")

  @@map("competitions")
  @@index([externalId])
  @@index([sport])
  @@index([isActive])
}

model Team {
  id          String   @id @default(cuid())
  externalId  String   @unique @map("external_id")
  name        String
  shortName   String?  @map("short_name")
  logoUrl     String?  @map("logo_url")
  country     String?
  syncedAt    DateTime @default(now()) @map("synced_at")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  homeMatches Match[]            @relation("HomeTeam")
  awayMatches Match[]            @relation("AwayTeam")
  players     Player[]
  favoritedBy UserFavoriteTeam[]

  @@map("teams")
  @@index([externalId])
  @@index([name])
}

model Player {
  id          String    @id @default(cuid())
  externalId  String    @unique @map("external_id")
  teamId      String    @map("team_id")
  name        String
  nationality String?
  position    String?
  number      String?
  dateOfBirth DateTime? @map("date_of_birth")
  height      String?
  weight      String?
  photoUrl    String?   @map("photo_url")
  syncedAt    DateTime  @default(now()) @map("synced_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  // Relations
  team        Team      @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@map("players")
  @@index([teamId])
  @@index([externalId])
  @@index([name])
}

model Match {
  id            String   @id @default(cuid())
  externalId    String   @unique @map("external_id")
  competitionId String   @map("competition_id")
  homeTeamId    String   @map("home_team_id")
  awayTeamId    String   @map("away_team_id")
  startTime     DateTime @map("start_time")
  status        String   @default("upcoming") // upcoming, live, finished, postponed, cancelled
  homeScore     Int?     @map("home_score")
  awayScore     Int?     @map("away_score")
  venue         String?
  round         String?
  syncedAt      DateTime @default(now()) @map("synced_at")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Relations
  competition   Competition @relation(fields: [competitionId], references: [id], onDelete: Cascade)
  homeTeam      Team        @relation("HomeTeam", fields: [homeTeamId], references: [id], onDelete: Cascade)
  awayTeam      Team        @relation("AwayTeam", fields: [awayTeamId], references: [id], onDelete: Cascade)
  bets          Bet[]
  groupBets     GroupBet[]
  odds          MatchOdds?

  @@map("matches")
  @@index([externalId])
  @@index([competitionId])
  @@index([homeTeamId])
  @@index([awayTeamId])
  @@index([status])
  @@index([startTime])
}

model SyncLog {
  id            String   @id @default(cuid())
  type          String   // "competitions", "teams", "matches"
  competitionId String?  @map("competition_id")
  status        String   // "success", "error", "partial"
  itemsSynced   Int      @default(0) @map("items_synced")
  durationMs    Int      @map("duration_ms")
  error         String?  @db.Text
  createdAt     DateTime @default(now()) @map("created_at")

  // Relations
  competition   Competition? @relation(fields: [competitionId], references: [id], onDelete: SetNull)

  @@map("sync_logs")
  @@index([type])
  @@index([status])
  @@index([createdAt])
}

// ============================================
// USER & AUTHENTICATION MODELS
// ============================================

model User {
  id            String   @id @default(cuid())
  email         String   @unique
  username      String   @unique
  passwordHash  String   @map("password_hash")
  firstName     String?  @map("first_name")
  lastName      String?  @map("last_name")
  avatar        String?
  isActive      Boolean  @default(true) @map("is_active")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Relations
  ownedLeagues        League[]             @relation("LeagueOwner")
  memberships         LeagueMember[]
  bets                Bet[]
  refreshTokens       RefreshToken[]
  passwordResetTokens PasswordResetToken[]
  createdGroupBets    GroupBet[]           @relation("GroupBetCreator")
  favoriteTeams       UserFavoriteTeam[]

  @@map("users")
  @@index([email])
  @@index([username])
}

model UserFavoriteTeam {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  teamId    String   @map("team_id")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  team      Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@unique([userId, teamId])
  @@map("user_favorite_teams")
  @@index([userId])
  @@index([teamId])
}

model RefreshToken {
  id          String   @id @default(cuid())
  userId      String   @map("user_id")
  tokenHash   String   @unique @map("token_hash")
  expiresAt   DateTime @map("expires_at")
  createdAt   DateTime @default(now()) @map("created_at")
  revokedAt   DateTime? @map("revoked_at")

  // Relations
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("refresh_tokens")
  @@index([userId])
  @@index([tokenHash])
  @@index([expiresAt])
}

model PasswordResetToken {
  id          String   @id @default(cuid())
  userId      String   @map("user_id")
  tokenHash   String   @unique @map("token_hash")
  expiresAt   DateTime @map("expires_at")
  usedAt      DateTime? @map("used_at")
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("password_reset_tokens")
  @@index([userId])
  @@index([tokenHash])
  @@index([expiresAt])
}

// ============================================
// LEAGUE & BETTING MODELS
// ============================================

model League {
  id                    String    @id @default(cuid())
  name                  String
  description           String?   @db.Text
  isPrivate             Boolean   @default(true) @map("is_private")
  ownerId               String    @map("owner_id")
  inviteCode            String    @unique @map("invite_code")
  isActive              Boolean   @default(true) @map("is_active")
  currentCompetitionId  String?   @map("current_competition_id")
  competitionChangedAt  DateTime? @map("competition_changed_at")
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  // Relations
  owner              User          @relation("LeagueOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  currentCompetition Competition?  @relation("LeagueCompetition", fields: [currentCompetitionId], references: [id], onDelete: SetNull)
  members            LeagueMember[]
  bets               Bet[]
  groupBets          GroupBet[]

  @@map("leagues")
  @@index([ownerId])
  @@index([inviteCode])
  @@index([isActive])
  @@index([currentCompetitionId])
}

model LeagueMember {
  id        String   @id @default(cuid())
  leagueId  String   @map("league_id")
  userId    String   @map("user_id")
  role      String   @default("member") // owner, admin, member
  points    Int      @default(1000) // Starting points
  joinedAt  DateTime @default(now()) @map("joined_at")

  // Relations
  league    League   @relation(fields: [leagueId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([leagueId, userId])
  @@map("league_members")
  @@index([leagueId])
  @@index([userId])
}

model Bet {
  id              String    @id @default(cuid())
  userId          String    @map("user_id")
  matchId         String    @map("match_id")
  leagueId        String    @map("league_id")
  groupBetId      String?   @map("group_bet_id")
  predictionType  String    @map("prediction_type") // winner, score, both_score, etc.
  predictionValue String    @map("prediction_value") @db.Text // JSON string
  amount          Int       // Points wagered
  status          String    @default("pending") // pending, won, lost, void
  potentialWin    Int?      @map("potential_win")
  actualWin       Int?      @map("actual_win")
  createdAt       DateTime  @default(now()) @map("created_at")
  settledAt       DateTime? @map("settled_at")

  // Relations
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  match           Match     @relation(fields: [matchId], references: [id], onDelete: Cascade)
  league          League    @relation(fields: [leagueId], references: [id], onDelete: Cascade)
  groupBet        GroupBet? @relation(fields: [groupBetId], references: [id], onDelete: SetNull)

  @@unique([userId, groupBetId]) // Un seul pari par utilisateur par challenge
  @@map("bets")
  @@index([userId])
  @@index([matchId])
  @@index([leagueId])
  @@index([groupBetId])
  @@index([status])
  @@index([createdAt])
}

// ============================================
// GROUP BET (CHALLENGE) MODEL
// ============================================

model GroupBet {
  id          String    @id @default(cuid())
  leagueId    String    @map("league_id")
  matchId     String    @map("match_id")
  createdById String    @map("created_by_id")
  status      String    @default("open") // open, closed, settled
  closesAt    DateTime  @map("closes_at") // M-10 du match
  createdAt   DateTime  @default(now()) @map("created_at")
  settledAt   DateTime? @map("settled_at")

  // Relations
  league      League    @relation(fields: [leagueId], references: [id], onDelete: Cascade)
  match       Match     @relation(fields: [matchId], references: [id], onDelete: Cascade)
  createdBy   User      @relation("GroupBetCreator", fields: [createdById], references: [id], onDelete: Cascade)
  bets        Bet[]

  @@unique([leagueId, matchId]) // Un seul challenge par match par ligue
  @@map("group_bets")
  @@index([leagueId])
  @@index([matchId])
  @@index([createdById])
  @@index([status])
  @@index([closesAt])
}

// ============================================
// ODDS DATA (The Odds API sync)
// ============================================

model MatchOdds {
  id              String   @id @default(cuid())
  matchId         String   @unique @map("match_id")
  oddsApiId       String?  @map("odds_api_id") // ID de The Odds API
  homeWinOdds     Float?   @map("home_win_odds") // Cote moyenne victoire domicile
  drawOdds        Float?   @map("draw_odds") // Cote moyenne match nul
  awayWinOdds     Float?   @map("away_win_odds") // Cote moyenne victoire extérieur
  bookmakerCount  Int      @default(0) @map("bookmaker_count") // Nombre de bookmakers utilisés pour la moyenne
  rawData         Json?    @map("raw_data") // Données brutes pour debug/historique
  syncedAt        DateTime @default(now()) @map("synced_at")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Relations
  match           Match    @relation(fields: [matchId], references: [id], onDelete: Cascade)

  @@map("match_odds")
  @@index([matchId])
  @@index([syncedAt])
}
